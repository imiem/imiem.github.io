<ul id="markdown-toc">
  <li><a href="#工具" id="markdown-toc-工具">工具</a></li>
  <li><a href="#模拟分布式" id="markdown-toc-模拟分布式">模拟分布式</a></li>
  <li><a href="#创建一个springboot项目" id="markdown-toc-创建一个springboot项目">创建一个springboot项目</a></li>
  <li><a href="#配置redis和访问的端口" id="markdown-toc-配置redis和访问的端口">配置redis和访问的端口</a></li>
  <li><a href="#配置redis缓存session" id="markdown-toc-配置redis缓存session">配置redis缓存session</a></li>
  <li><a href="#编写一个测试的控制类" id="markdown-toc-编写一个测试的控制类">编写一个测试的控制类</a></li>
  <li><a href="#测试" id="markdown-toc-测试">测试</a></li>
  <li><a href="#目前缺点" id="markdown-toc-目前缺点">目前缺点</a></li>
  <li><a href="#参考资料" id="markdown-toc-参考资料">参考资料</a></li>
</ul>
<p>当创建分布式服务时会出现session共享的问题，即第一次访问的时候负载均衡会将请求分配到server1上，但是当第二次访问的时候，如果请求没有分配到server1上，那么用户的会话状态将丢失。下面给出了一种使用springboot整合redis的共享session的例子。</p>

<h2 id="工具">工具</h2>

<ul>
  <li>nginx-1.7.10</li>
  <li>redis-2.8</li>
</ul>

<h2 id="模拟分布式">模拟分布式</h2>

<p>使用nginx模拟一个简单的分布式的环境，在nginx.conf中添加</p>
<div class="highlighter-rouge"><pre class="highlight"><code>upstream  tomcat  {  
        server    127.0.0.1:8088  weight=1;
        server    127.0.0.1:9090  weight=2;  
} 
</code></pre>
</div>
<p>修改监听的端口，即所有的访问都通过83进行反向代理</p>
<div class="highlighter-rouge"><pre class="highlight"><code> server {
        listen       83;
        server_name  localhost;
    }
</code></pre>
</div>

<h2 id="创建一个springboot项目">创建一个springboot项目</h2>

<p>在pom文件中加入</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
	<span class="nt">&lt;dependency&gt;</span>
		<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
		<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;/dependency&gt;</span>

	<span class="nt">&lt;dependency&gt;</span>
		<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
		<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;/dependency&gt;</span>

	<span class="nt">&lt;dependency&gt;</span>
		<span class="nt">&lt;groupId&gt;</span>org.springframework.session<span class="nt">&lt;/groupId&gt;</span>
		<span class="nt">&lt;artifactId&gt;</span>spring-session-data-redis<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;/dependency&gt;</span>

	<span class="nt">&lt;dependency&gt;</span>
		<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
		<span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
		<span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
	<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre>
</div>

<h2 id="配置redis和访问的端口">配置redis和访问的端口</h2>

<p>在application.properties中添加</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">spring</span><span class="o">.</span><span class="na">redis</span><span class="o">.</span><span class="na">host</span><span class="o">=</span><span class="n">localhost</span>
<span class="n">spring</span><span class="o">.</span><span class="na">redis</span><span class="o">.</span><span class="na">port</span><span class="o">=</span><span class="mi">16001</span>

<span class="n">server</span><span class="o">.</span><span class="na">port</span><span class="o">=</span><span class="mi">9090</span>

</code></pre>
</div>

<h2 id="配置redis缓存session">配置redis缓存session</h2>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableRedisHttpSession</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfig</span> <span class="o">{</span>
<span class="o">}</span>

</code></pre>
</div>

<h2 id="编写一个测试的控制类">编写一个测试的控制类</h2>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/api/v1"</span><span class="o">)</span>
<span class="nd">@PropertySource</span><span class="o">(</span><span class="s">"classpath:application.properties"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${server.port}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">port</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/first"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">firstResp</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURL</span><span class="o">());</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"url"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURL</span><span class="o">());</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"port"</span><span class="o">,</span><span class="n">port</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/sessions"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">sessions</span> <span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">){</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"sessionId"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"url"</span><span class="o">));</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"port"</span><span class="o">,</span><span class="n">port</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre>
</div>

<h2 id="测试">测试</h2>

<p>复制一份相同的代码，然后区分访问端口为8088和9090</p>

<ul>
  <li>访问：http://localhost:83/api/v1/first</li>
</ul>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="err">port:</span><span class="w"> </span><span class="nt">"9090"</span><span class="err">,</span><span class="w">
	</span><span class="err">url</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://tomcat/api/v1/first"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li>多次访问：http://localhost:83/api/v1/sessions</li>
</ul>

<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="err">port:</span><span class="w"> </span><span class="nt">"9090"</span><span class="err">,</span><span class="w">
	</span><span class="err">sessionId</span><span class="p">:</span><span class="w"> </span><span class="s2">"2e35353c-4d9e-4588-8257-43b54da9adc7"</span><span class="p">,</span><span class="w">
	</span><span class="err">message</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://tomcat/api/v1/first"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="p">{</span><span class="w">
	</span><span class="err">port:</span><span class="w"> </span><span class="nt">"8088"</span><span class="err">,</span><span class="w">
	</span><span class="err">sessionId</span><span class="p">:</span><span class="w"> </span><span class="s2">"2e35353c-4d9e-4588-8257-43b54da9adc7"</span><span class="p">,</span><span class="w">
	</span><span class="err">message</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://tomcat/api/v1/first"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre>
</div>
<p>虽然访问落到不同的服务下，但是每次获取的sessionId是相同的，即达到了session共享的目的。</p>

<h2 id="目前缺点">目前缺点</h2>
<ul>
  <li>目前nginx的配置，当一个服务挂掉的时候访问依然会落到这个服务商</li>
  <li>目前的redis没有实现集群管理，当redis挂掉的时候，所有的session都将失效</li>
</ul>

<h2 id="参考资料">参考资料</h2>
<ul>
  <li>
    <p><a href="https://github.com/MrDebuger/blog_src/tree/master/redis-session">代码地址</a></p>
  </li>
  <li><a href="http://www.cnblogs.com/mengmeng89012/p/5519698.html">http://www.cnblogs.com/mengmeng89012/p/5519698.html</a></li>
  <li>可以参考github上的已有的集成方案<a href="https://github.com/jcoleman/tomcat-redis-session-manager">https://github.com/jcoleman/tomcat-redis-session-manager</a></li>
</ul>

